<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purely Homemade - Product Detail</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../assets/css/style.css">
  <link rel="stylesheet" href="../../../public/css/product_detail.css">
  <link rel="stylesheet" href="../../../public/css/navbar.css">

  <!-- Google Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<!-- Breadcrumb -->
<div class="container mt-3">
  <nav>
    <ol class="breadcrumb" id="breadcrumb">
      <li class="breadcrumb-item"><a href="../../../index.html">Home</a></li>
      <li class="breadcrumb-item" id="breadcrumb-category-link"><a href="#">Category</a></li>
      <li class="breadcrumb-item active" id="breadcrumb-item">Item Name</li>
    </ol>
  </nav>
</div>


<!-- Item details section -->
<div class="container">
  <div class="row align-items-start">
    <!-- Left Side: Product Images -->
    <div class="col-md-6">
      <div class="d-flex justify-content-start">
        <!-- Thumbnail Images -->
        <div class="thumbnail-column" id="thumbnail-images">
          <!-- Thumbnails will be added dynamically -->
        </div>

        <!-- Main Image -->
        <div class="main-image-container">
          <img id="product-image" src="" alt="Product Image" class="img-fluid">
        </div>
      </div>

      <!-- Customer Reviews -->
      <div class="customer-reviews mt-5">
        <h3>Customer Reviews</h3>
        <div class="rating" id="product-rating">
          <!-- Rating will be loaded dynamically -->
        </div>
        <div id="reviews-container" class="mt-4">
          <!-- Reviews will be loaded dynamically -->
        </div>
      </div>
    </div>

    <!-- Right Side: Product Info -->
    <div class="col-md-6">
      <h2 id="product-title"></h2>
      <div id="product-price-container" class="mb-3">
        <span id="product-price" class="fw-bold fs-4"></span>
        <span id="product-original-price" class="text-decoration-line-through text-muted ms-2"></span>
      </div>
      
      <div class="d-flex align-items-center mb-3">
        <div class="input-group" style="width: 120px;">
          <button class="btn btn-outline-secondary" type="button" id="decrease-quantity">-</button>
          <input type="text" class="form-control text-center" id="product-quantity" value="1">
          <button class="btn btn-outline-secondary" type="button" id="increase-quantity">+</button>
        </div>
        <button class="btn btn-primary ms-3" id="add-to-cart">Add to Cart</button>
      </div>

      <div class="alert alert-success d-none" id="add-success-alert">
        Product added to cart successfully!
      </div>

      <!-- Product Info Sections -->
      <div class="product-info mt-4">
        <button class="accordion">Description</button>
        <div class="panel"><p id="product-description"></p></div>

        <button class="accordion">Details</button>
        <div class="panel" id="product-details">
          <p>Loading product details...</p>
        </div>

        <button class="accordion">Shipping & Returns</button>
        <div class="panel">
          <p>Free shipping on orders over $50.</p>
          <p>Returns accepted within 30 days of delivery. Item must be unused and in original packaging.</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- You May Also Like Section -->
<div class="container mt-5 mb-5">
  <h3 class="mb-4">You May Also Like</h3>
  <div class="row" id="related-products">
    <!-- Related products will be loaded dynamically -->
  </div>
</div>

<!-- Toast通知容器 -->
<div class="toast-container" id="toast-container"></div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- Bootstrap JS and jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 初始化数据脚本 -->
<script src="../../assets/js/init-data.js"></script>

<script>
  // Load navbar and footer
  fetch('../../assets/layout/navbar.html')
    .then(response => {
      if (!response.ok) {
        throw new Error(`Failed to load navbar (${response.status})`);
      }
      return response.text();
    })
    .then(html => {
      document.getElementById('navbar-placeholder').innerHTML = html;
      console.log('Navbar loaded successfully');
      
      // Update cart count after navbar is loaded
      if (typeof updateCartCount === 'function') {
        updateCartCount();
      }
    })
    .catch(error => {
      console.error('Error loading navbar:', error);
      document.getElementById('navbar-placeholder').innerHTML =
        '<div class="alert alert-danger">Failed to load navigation bar. Please check console for details.</div>';
    });

  fetch('../../assets/layout/footer.html')
    .then(response => {
      if (!response.ok) {
        throw new Error(`Failed to load footer (${response.status})`);
      }
      return response.text();
    })
    .then(html => {
      document.getElementById('footer-placeholder').innerHTML = html;
      console.log('Footer loaded successfully');
    })
    .catch(error => {
      console.error('Error loading footer:', error);
      document.getElementById('footer-placeholder').innerHTML =
        '<div class="alert alert-danger">Failed to load footer. Please check console for details.</div>';
    });
    
  // 确保数据初始化
  document.addEventListener('DOMContentLoaded', function() {
    // 初始化数据
    if (typeof window.initializeData === 'function') {
      window.initializeData();
    }
    
    // 初始化手风琴
    const accordions = document.querySelectorAll('.accordion');
    accordions.forEach(accordion => {
      accordion.addEventListener('click', function() {
        this.classList.toggle('active');
        const panel = this.nextElementSibling;
        if (panel.style.maxHeight) {
          panel.style.maxHeight = null;
        } else {
          panel.style.maxHeight = panel.scrollHeight + 'px';
        }
      });
    });
    
    // 加载产品详情
    loadProductDetails();
    
    // 监听数量增减按钮
    document.getElementById('increase-quantity').addEventListener('click', function() {
      const quantityInput = document.getElementById('product-quantity');
      let quantity = parseInt(quantityInput.value);
      quantityInput.value = quantity + 1;
    });
    
    document.getElementById('decrease-quantity').addEventListener('click', function() {
      const quantityInput = document.getElementById('product-quantity');
      let quantity = parseInt(quantityInput.value);
      if (quantity > 1) {
        quantityInput.value = quantity - 1;
      }
    });
    
    // 添加到购物车按钮
    document.getElementById('add-to-cart').addEventListener('click', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const productId = parseInt(urlParams.get('id'));
      const quantity = parseInt(document.getElementById('product-quantity').value);
      
      addToCart(productId, quantity);
    });
  });
  
  // 加载产品详情
  function loadProductDetails() {
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    
    if (!productId) {
      showError('产品ID不存在');
      return;
    }
    
    const productsData = localStorage.getItem('products');
    if (!productsData) {
      showError('产品数据不存在');
      return;
    }
    
    const products = JSON.parse(productsData);
    const product = products.find(p => p.id == productId);
    
    if (!product) {
      showError('找不到该产品');
      return;
    }
    
    // 更新产品信息
    document.title = `${product.name} - Purely Homemade`;
    document.getElementById('product-title').textContent = product.name;
    document.getElementById('product-description').textContent = product.description;
    document.getElementById('breadcrumb-item').textContent = product.name;
    
    // 更新价格
    if (product.onSale && product.salePrice) {
      document.getElementById('product-price').textContent = `$${product.salePrice.toFixed(2)}`;
      document.getElementById('product-original-price').textContent = `$${product.price.toFixed(2)}`;
    } else {
      document.getElementById('product-price').textContent = `$${product.price.toFixed(2)}`;
      document.getElementById('product-original-price').textContent = '';
    }
    
    // 更新图片
    document.getElementById('product-image').src = product.images[0];
    
    // 更新缩略图
    const thumbnailContainer = document.getElementById('thumbnail-images');
    thumbnailContainer.innerHTML = '';
    
    product.images.forEach((image, index) => {
      const thumbnailImg = document.createElement('img');
      thumbnailImg.src = image;
      thumbnailImg.alt = `Thumbnail ${index + 1}`;
      thumbnailImg.className = 'thumbnail-img';
      thumbnailImg.addEventListener('click', function() {
        document.getElementById('product-image').src = image;
      });
      thumbnailContainer.appendChild(thumbnailImg);
    });
    
    // 更新评分
    updateRating(product);
    
    // 更新详细信息
    updateProductDetails(product);
    
    // 加载相关产品
    loadRelatedProducts(product);
    
    // 加载评论
    loadReviews(product);
    
    // 更新面包屑
    updateBreadcrumb(product);
  }
  
  // 更新评分显示
  function updateRating(product) {
    const ratingContainer = document.getElementById('product-rating');
    
    // 生成星级评分HTML
    const fullStars = Math.floor(product.rating);
    const hasHalfStar = product.rating % 1 >= 0.5;
    
    let starsHtml = '<span class="text-warning">';
    for (let j = 0; j < fullStars; j++) {
      starsHtml += '<i class="bi bi-star-fill"></i> ';
    }
    if (hasHalfStar) {
      starsHtml += '<i class="bi bi-star-half"></i> ';
    }
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
    for (let j = 0; j < emptyStars; j++) {
      starsHtml += '<i class="bi bi-star"></i> ';
    }
    starsHtml += `</span> <span class="text-muted">(${product.rating.toFixed(1)} out of 5, ${product.reviewCount} reviews)</span>`;
    
    ratingContainer.innerHTML = starsHtml;
  }
  
  // 更新产品详细信息
  function updateProductDetails(product) {
    const detailsContainer = document.getElementById('product-details');
    let detailsHtml = '<ul class="list-group list-group-flush">';
    
    if (product.material) {
      detailsHtml += `<li class="list-group-item"><strong>Material:</strong> ${product.material}</li>`;
    }
    
    if (product.dimensions) {
      detailsHtml += `<li class="list-group-item"><strong>Dimensions:</strong> ${product.dimensions}</li>`;
    }
    
    if (product.weight) {
      detailsHtml += `<li class="list-group-item"><strong>Weight:</strong> ${product.weight}</li>`;
    }
    
    // 添加其他可能的详细信息
    detailsHtml += `<li class="list-group-item"><strong>SKU:</strong> SKU-${product.id.toString().padStart(5, '0')}</li>`;
    
    // 获取分类信息
    const categoriesData = localStorage.getItem('categories');
    if (categoriesData) {
      const categories = JSON.parse(categoriesData);
      const category = categories.find(c => c.id === product.categoryId);
      if (category) {
        detailsHtml += `<li class="list-group-item"><strong>Category:</strong> ${category.name}</li>`;
      }
    }
    
    detailsHtml += '</ul>';
    detailsContainer.innerHTML = detailsHtml;
  }
  
  // 加载相关产品
  function loadRelatedProducts(product) {
    const relatedContainer = document.getElementById('related-products');
    const productsData = localStorage.getItem('products');
    
    if (productsData) {
      const products = JSON.parse(productsData);
      
      // 根据同类别筛选相关产品
      let relatedProducts = products.filter(p => 
        p.categoryId === product.categoryId && p.id !== product.id
      );
      
      // 如果同类别产品不足4个，则添加其他产品
      if (relatedProducts.length < 4) {
        const otherProducts = products.filter(p => 
          p.categoryId !== product.categoryId && p.id !== product.id
        );
        relatedProducts = relatedProducts.concat(otherProducts.slice(0, 4 - relatedProducts.length));
      }
      
      // 最多显示4个相关产品
      relatedProducts = relatedProducts.slice(0, 4);
      
      relatedProducts.forEach(relatedProduct => {
        // 生成星级评分HTML
        const fullStars = Math.floor(relatedProduct.rating);
        const hasHalfStar = relatedProduct.rating % 1 >= 0.5;
        
        let starsHtml = '<span class="text-warning">';
        for (let j = 0; j < fullStars; j++) {
          starsHtml += '<i class="bi bi-star-fill"></i> ';
        }
        if (hasHalfStar) {
          starsHtml += '<i class="bi bi-star-half"></i> ';
        }
        const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
        for (let j = 0; j < emptyStars; j++) {
          starsHtml += '<i class="bi bi-star"></i> ';
        }
        starsHtml += `</span>`;
        
        // 价格显示
        let priceHtml = '';
        if (relatedProduct.onSale && relatedProduct.salePrice) {
          priceHtml = `
            <span class="product-price">$${relatedProduct.salePrice.toFixed(2)}</span>
            <span class="product-price-discount">$${relatedProduct.price.toFixed(2)}</span>
          `;
        } else {
          priceHtml = `<span class="product-price">$${relatedProduct.price.toFixed(2)}</span>`;
        }
        
        const productHtml = `
          <div class="col-md-3 col-sm-6 product-item">
            <div class="product-card">
              <a href="product_detail.html?id=${relatedProduct.id}" class="text-decoration-none text-dark">
                <img src="${relatedProduct.images[0]}" class="card-img-top product-img" alt="${relatedProduct.name}" style="height: 180px; object-fit: cover;">
                ${relatedProduct.onSale ? '<div class="product-badge">Sale</div>' : ''}
                <div class="card-body">
                  <h5 class="card-title" style="font-size: 0.9rem;">${relatedProduct.name}</h5>
                  <div class="mb-2">${priceHtml}</div>
                  <div class="mb-2">${starsHtml}</div>
                </div>
              </a>
            </div>
            <button class="btn btn-primary btn-sm add-to-cart-btn" data-product-id="${relatedProduct.id}">
              <i class="bi bi-cart-plus"></i> Add
            </button>
          </div>
        `;
        
        relatedContainer.innerHTML += productHtml;
      });
      
      // 添加Add to Cart按钮事件
      document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', function() {
          const productId = parseInt(this.getAttribute('data-product-id'));
          addToCart(productId, 1);
        });
      });
    }
  }
  
  // 加载评论
  function loadReviews(product) {
    const reviewsContainer = document.getElementById('reviews-container');
    
    // 检查是否有评论
    if (!product.reviews || product.reviews.length === 0) {
      reviewsContainer.innerHTML = '<p class="text-muted">No reviews yet for this product.</p>';
      return;
    }
    
    let reviewsHtml = '';
    product.reviews.forEach(review => {
      // 生成星级评分HTML
      let starsHtml = '<span class="text-warning">';
      for (let j = 0; j < review.rating; j++) {
        starsHtml += '<i class="bi bi-star-fill"></i> ';
      }
      for (let j = review.rating; j < 5; j++) {
        starsHtml += '<i class="bi bi-star"></i> ';
      }
      starsHtml += '</span>';
      
      reviewsHtml += `
        <div class="card mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <div>${starsHtml}</div>
              <small class="text-muted">${review.date}</small>
            </div>
            <h6 class="card-subtitle mb-2">${review.name}</h6>
            <p class="card-text">${review.comment}</p>
          </div>
        </div>
      `;
    });
    
    reviewsContainer.innerHTML = reviewsHtml;
  }
  
  // 更新面包屑
  function updateBreadcrumb(product) {
    const categoriesData = localStorage.getItem('categories');
    if (categoriesData) {
      const categories = JSON.parse(categoriesData);
      const category = categories.find(c => c.id === product.categoryId);
      
      if (category) {
        const categoryLink = document.getElementById('breadcrumb-category-link');
        categoryLink.querySelector('a').textContent = category.name;
        categoryLink.querySelector('a').href = `#`;
      }
    }
  }
  
  // 添加到购物车
  function addToCart(productId, quantity) {
    const productsData = localStorage.getItem('products');
    if (!productsData) return;
    
    const products = JSON.parse(productsData);
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    // 获取现有购物车
    let cart = [];
    const cartData = localStorage.getItem('cart');
    if (cartData) {
      cart = JSON.parse(cartData);
    }
    
    // 检查产品是否已在购物车中
    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
      existingItem.quantity += quantity;
    } else {
      cart.push({
        id: product.id,
        name: product.name,
        price: product.onSale && product.salePrice ? product.salePrice : product.price,
        image: product.images[0],
        quantity: quantity
      });
    }
    
    // 保存到localStorage
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // 显示成功消息
    showToast(`${product.name} added to your cart!`, 'success');
    
    // 更新导航栏购物车计数
    updateCartCount();
  }
  
  // 更新购物车计数
  function updateCartCount() {
    const cartData = localStorage.getItem('cart');
    const cartCount = document.getElementById('cart-count');
    
    if (!cartCount) return;
    
    if (cartData) {
      const cart = JSON.parse(cartData);
      const count = cart.reduce((total, item) => total + item.quantity, 0);
      cartCount.textContent = count;
      cartCount.style.display = count > 0 ? 'inline-block' : 'none';
    } else {
      cartCount.style.display = 'none';
    }
  }
  
  // 显示错误信息
  function showError(message) {
    document.querySelector('.container').innerHTML = `
      <div class="alert alert-danger mt-5">
        <h4>Error</h4>
        <p>${message}</p>
        <a href="../../../index.html" class="btn btn-primary">Return to Home</a>
      </div>
    `;
  }
  
  // 显示Toast通知
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    
    if (!toastContainer) return;
    
    // 创建toast元素
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.style.backgroundColor = '#fff';
    toast.style.color = '#333';
    toast.style.borderRadius = '4px';
    toast.style.padding = '10px 15px';
    toast.style.marginBottom = '10px';
    toast.style.minWidth = '250px';
    toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    toast.style.display = 'flex';
    toast.style.alignItems = 'center';
    toast.style.animation = 'slideIn 0.3s, fadeOut 0.5s 2.5s forwards';
    toast.style.position = 'relative';
    
    if (type === 'success') {
      toast.style.borderLeft = '4px solid #198754';
    } else if (type === 'error') {
      toast.style.borderLeft = '4px solid #dc3545';
    }
    
    // 添加内容
    toast.innerHTML = `
      <div style="flex: 1; padding-right: 10px;">${message}</div>
      <div style="cursor: pointer; font-size: 16px; color: #999;">&times;</div>
    `;
    
    // 添加到容器
    toastContainer.appendChild(toast);
    
    // 添加关闭按钮事件
    const closeBtn = toast.querySelector('div:last-child');
    closeBtn.addEventListener('click', function() {
      toast.remove();
    });
    
    // 自动3秒后移除
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
</script>

<style>
  /* 缩略图样式 */
  .thumbnail-column {
    display: flex;
    flex-direction: column;
    margin-right: 15px;
  }
  
  .thumbnail-img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .thumbnail-img:hover {
    border-color: #0d6efd;
  }
  
  /* 产品信息面板样式 */
  .accordion {
    background-color: #f8f9fa;
    color: #212529;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    text-align: left;
    border: none;
    outline: none;
    transition: 0.4s;
    margin-bottom: 2px;
    font-weight: 500;
    position: relative;
  }

  .accordion:after {
    content: '\002B';
    color: #777;
    font-weight: bold;
    float: right;
  }

  .active:after {
    content: "\2212";
  }

  .panel {
    padding: 0 18px;
    background-color: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
    margin-bottom: 10px;
  }
  
  .panel p {
    padding: 15px 0;
  }
  
  /* Toast 通知样式 */
  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }
  
  .toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
  }
  
  /* 产品卡片样式 */
  .product-card {
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  
  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
  }
  
  .product-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background-color: #dc3545;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .product-price {
    font-weight: 600;
    color: #0d6efd;
    font-size: 1.1rem;
  }
  
  .product-price-discount {
    text-decoration: line-through;
    color: #6c757d;
    font-size: 0.9rem;
    margin-left: 5px;
  }
  
  /* 产品定位 */
  .product-item {
    position: relative;
  }
  
  .add-to-cart-btn {
    position: absolute;
    bottom: 15px;
    right: 15px;
    z-index: 10;
  }
  
  /* 评论列表增强样式 */
  .customer-reviews {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
  }
  
  .card {
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s;
  }
  
  .card:hover {
    transform: translateY(-3px);
  }
</style>
</body>
</html>
