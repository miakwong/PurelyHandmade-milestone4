<script>
  // Load navbar and footer content dynamically
  loadLayoutComponents();

  // Avatar upload preview
  document.getElementById('avatar-wrapper').addEventListener('click', function () {
    document.getElementById('avatar-input').click();
  });

  document.getElementById('avatar-input').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (event) {
        const imgUrl = event.target.result;
        document.querySelector('.avatar-placeholder').innerHTML = `<img src="${imgUrl}" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover;">`;
      };
      reader.readAsDataURL(file);
    }
  });

  // Form validation and submission
  const form = document.getElementById('register-form');
  const password = document.getElementById('password');
  const confirmPassword = document.getElementById('confirmPassword');
  const emailInput = document.getElementById('email');
  const usernameInput = document.getElementById('username');

  //check email
  emailInput.addEventListener('blur', async function () {
    const email = this.value.trim();

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      this.classList.add('is-invalid');
      this.nextElementSibling.textContent = 'Please enter a valid email address.';
      return;
    }

    try {
      const emailCheck = await fetch(getApiUrl(`users.php?action=check_email&email=${encodeURIComponent(email)}`), {
        method: 'GET'
      });

      if (!emailCheck.ok) {
        throw new Error(`HTTP error! status: ${emailCheck.status}`);
      }

      const responseText = await emailCheck.text();
      let emailResult;
      try {
        emailResult = JSON.parse(responseText);
      } catch (e) {
        console.error('JSON parse error:', e);
        throw new Error('Invalid response from server');
      }

      if (!emailResult.success) {
        this.classList.add('is-invalid');
        this.nextElementSibling.textContent = emailResult.data?.message || 'Email check failed';
        return;
      }

      if (!emailResult.data.available) {
        this.classList.add('is-invalid');
        this.nextElementSibling.textContent = emailResult.data.message;
      } else {
        this.classList.remove('is-invalid');
      }
    } catch (error) {
      console.error('Email check error:', error);
      this.classList.add('is-invalid');
      this.nextElementSibling.textContent = 'Failed to check email availability. Please try again.';
    }
  });

  // Add username validation on blur
  usernameInput.addEventListener('blur', async function () {
    const username = this.value.trim();
    if (!username) return;

    try {
      const usernameCheck = await fetch(getApiUrl(`users.php?action=check_username&username=${encodeURIComponent(username)}`), {
        method: 'GET'
      });

      if (!usernameCheck.ok) {
        throw new Error(`HTTP error! status: ${usernameCheck.status}`);
      }

      const responseText = await usernameCheck.text();
      let usernameResult;
      try {
        usernameResult = JSON.parse(responseText);
      } catch (e) {
        console.error('JSON parse error:', e);
        throw new Error('Invalid response from server');
      }

      if (!usernameResult.success) {
        this.classList.add('is-invalid');
        this.nextElementSibling.textContent = usernameResult.data?.message || 'Username check failed';
        return;
      }

      if (!usernameResult.data.available) {
        this.classList.add('is-invalid');
        this.nextElementSibling.textContent = usernameResult.data.message;
      } else {
        this.classList.remove('is-invalid');
      }
    } catch (error) {
      console.error('Username check error:', error);
      this.classList.add('is-invalid');
      this.nextElementSibling.textContent = 'Failed to check username availability. Please try again.';
    }
  });

  form.addEventListener('keydown', function (event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      console.log('Enter key press prevented.');
    }
  });

  form.addEventListener('submit', async function (event) {
    event.preventDefault();

    form.classList.add('was-validated');

    // Get all form values
    const formData = {
      firstName: document.getElementById('firstName').value.trim(),
      lastName: document.getElementById('lastName').value.trim(),
      email: document.getElementById('email').value.trim(),
      username: document.getElementById('username').value.trim(),
      password: password.value,
      confirmPassword: confirmPassword.value,
      birthday: document.getElementById('birthday').value,
      gender: document.querySelector('input[name="gender"]:checked')?.value,
      avatar: document.querySelector('.avatar-placeholder img')?.src
    };

    // Clear previous errors
    form.querySelectorAll('.is-invalid').forEach(el => {
      el.classList.remove('is-invalid');
    });

    // Validate all fields
    let hasError = false;

    if (!formData.firstName) {
      document.getElementById('firstName').classList.add('is-invalid');
      hasError = true;
    }
    if (!formData.lastName) {
      document.getElementById('lastName').classList.add('is-invalid');
      hasError = true;
    }
    if (!formData.email) {
      document.getElementById('email').classList.add('is-invalid');
      hasError = true;
    }
    if (!formData.username) {
      document.getElementById('username').classList.add('is-invalid');
      hasError = true;
    }
    if (!formData.birthday) {
      document.getElementById('birthday').classList.add('is-invalid');
      hasError = true;
    }
    if (!formData.gender) {
      const genderContainer = document.querySelector('.gender-options');
      const genderFeedback = genderContainer.nextElementSibling;

      genderContainer.classList.add('is-invalid');
      genderFeedback.style.display = 'block';
      hasError = true;
    } else {
      const genderContainer = document.querySelector('.gender-options');
      const genderFeedback = genderContainer.nextElementSibling;

      genderContainer.classList.remove('is-invalid');
      genderFeedback.style.display = 'none';
    }
    if (!document.getElementById('terms').checked) {
      document.getElementById('terms').classList.add('is-invalid');
      hasError = true;
    }

    if (formData.password.length < 8) {
      password.classList.add('is-invalid');
      password.nextElementSibling.textContent = 'Password must be at least 8 characters long';
      hasError = true;
    } else if (!/[A-Z]/.test(formData.password) || !/\d/.test(formData.password)) {
      password.classList.add('is-invalid');
      password.nextElementSibling.textContent = 'Password must contain at least one uppercase letter and one number';
      hasError = true;
    }

    if (formData.password !== formData.confirmPassword) {
      confirmPassword.classList.add('is-invalid');
      hasError = true;
    }

    if (hasError) {
      return;
    }

    try {
      // add debug log
      console.log('Form data collected:', formData);

      // Prepare user data for registration
      const userData = {
        username: formData.username,
        email: formData.email,
        password: formData.password,
        firstName: formData.firstName,
        lastName: formData.lastName,
        name: `${formData.firstName} ${formData.lastName}`,
        avatar: formData.avatar ? formData.avatar.replace(/^data:image\/[a-z]+;base64,/, '') : null,
        birthday: formData.birthday,
        gender: formData.gender,
        role: 'user'
      };

      console.log('Sending registration data:', userData);

      // check if getApiUrl is defined
      if (typeof getApiUrl !== 'function') {
        console.error('getApiUrl function is not defined');
        getApiUrl = function (endpoint) {
          return `${config.apiUrl}/${endpoint}`;
        };
      }

      const apiUrl = getApiUrl('auth.php?action=register');
      console.log('API URL:', apiUrl);

      // Call register API
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData),
        credentials: 'include'
      });

      console.log('API response status:', response.status);
      const responseText = await response.text();
      console.log('API response text:', responseText);

      let result;
      try {
        result = JSON.parse(responseText);
        console.log('Parsed API response:', result);
      } catch (e) {
        console.error("JSON parse error:", e);
        console.error("Raw response:", responseText);
        throw new Error("Invalid JSON response");
      }

      if (result.success) {
        window.location.href = 'login.html';
      } else {
        document.getElementById('username').classList.add('is-invalid');
        document.getElementById('username').nextElementSibling.textContent = result.message || 'Registration failed. Please try again.';
      }
    } catch (error) {
      console.error('Registration error:', error);
      document.getElementById('username').classList.add('is-invalid');
      document.getElementById('username').nextElementSibling.textContent = 'An error occurred during registration. Please try again.';
    }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
