<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link href="/src/assets/css/global.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #0d6efd;
      --primary-light: rgba(13, 110, 253, 0.25);
      --text-muted: #6c757d;
      --border-color: #dee2e6;
      --bg-light: #f8f9fa;
      --success-color: #198754;
      --danger-color: #dc3545;
    }

    .profile-section {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .profile-header {
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .profile-avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .avatar-wrapper {
      position: relative;
      display: inline-block;
    }

    .avatar-wrapper:hover .avatar-overlay {
      opacity: 1;
    }

    .avatar-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      cursor: pointer;
    }

    .avatar-overlay i {
      color: white;
      font-size: 2rem;
    }

    .profile-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .detail-item {
      margin-bottom: 1rem;
    }

    .detail-label {
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .detail-value {
      font-size: 1.1rem;
    }

    .address-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .address-card.default {
      border-color: var(--primary-color);
      background-color: var(--primary-light);
    }

    .default-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: var(--primary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.75rem;
    }

    .address-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .no-addresses {
      text-align: center;
      padding: 2rem;
      background-color: var(--bg-light);
      border-radius: 8px;
      color: var(--text-muted);
    }

    .nav-tabs {
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 500;
    }

    /* Admin functionality styles */
    .admin-section {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .admin-section table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .admin-section th, .admin-section td {
      border: 1px solid var(--border-color);
      padding: 0.75rem;
      text-align: left;
    }

    .admin-section th {
      background-color: var(--bg-light);
    }

    .enable-btn {
      background-color: var(--success-color);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .disable-btn {
      background-color: var(--danger-color);
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }

    .view-more-btn {
      display: inline-block;
      margin-top: 1rem;
      color: var(--primary-color);
      text-decoration: none;
    }

    .admin-status-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 0.25rem;
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

<div class="container my-5">
  <h1 class="mb-4">My Profile</h1>

  <!-- Profile Overview Section -->
  <div class="profile-section">
    <div class="row">
      <div class="col-md-3 text-center">
        <div class="avatar-wrapper">
          <img src="../../assets/img/profile.png" alt="Profile Photo" id="profile-img" class="profile-avatar">
          <div class="avatar-overlay" onclick="document.getElementById('avatar-upload').click()">
            <i class="bi bi-camera"></i>
      </div>
          <input type="file" id="avatar-upload" accept="image/png, image/jpeg" onchange="updateProfilePhoto(event)" hidden>
        </div>
        <h3 id="user-full-name" class="mt-3">John Doe</h3>
        <p id="user-email" class="text-muted">johndoe@example.com</p>
        <p class="mb-0"><small class="text-muted">Member since <span id="join-date">January 2023</span></small></p>
      </div>
      <div class="col-md-9">
        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal-info" type="button" role="tab" aria-controls="personal-info" aria-selected="true">Personal Info</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab" aria-controls="addresses" aria-selected="false">Addresses</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">Security</button>
          </li>
          <li class="nav-item" role="presentation" id="admin-tab-container" style="display: none;">
            <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">Admin Features</button>
          </li>
        </ul>
        
        <div class="tab-content" id="profileTabsContent">
          <!-- Personal Info Tab -->
          <div class="tab-pane fade show active" id="personal-info" role="tabpanel" aria-labelledby="personal-tab">
            <div class="profile-header">
              <h4>Personal Information</h4>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                <i class="bi bi-pencil me-1"></i> Edit
              </button>
            </div>
            
            <div class="profile-details">
              <div class="detail-item">
                <div class="detail-label">First Name</div>
                <div class="detail-value" id="first-name">John</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Last Name</div>
                <div class="detail-value" id="last-name">Doe</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Email</div>
                <div class="detail-value" id="email-display">johndoe@example.com</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Birthday</div>
                <div class="detail-value" id="birthday-display">January 1, 1990</div>
              </div>
              <div class="detail-item">
                <div class="detail-label">Gender</div>
                <div class="detail-value" id="gender-display">Male</div>
              </div>
            </div>
          </div>
          
          <!-- Addresses Tab -->
          <div class="tab-pane fade" id="addresses" role="tabpanel" aria-labelledby="addresses-tab">
            <div class="profile-header">
              <h4>My Addresses</h4>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                <i class="bi bi-plus-lg me-1"></i> Add New Address
              </button>
            </div>
            
            <div id="addresses-container">
              <!-- Addresses will be loaded here -->
              <div class="no-addresses">
                <i class="bi bi-geo-alt display-4"></i>
                <p class="mt-3">You don't have any saved addresses yet.</p>
              </div>
            </div>
          </div>
          
          <!-- Security Tab -->
          <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
            <div class="profile-header">
              <h4>Security Settings</h4>
            </div>
            
            <div class="mb-4">
              <h5>Change Password</h5>
              <form id="change-password-form">
                <div class="mb-3">
                  <label for="current-password" class="form-label">Current Password</label>
                  <input type="password" class="form-control" id="current-password" required>
                </div>
                <div class="mb-3">
                  <label for="new-password" class="form-label">New Password</label>
                  <input type="password" class="form-control" id="new-password" required>
                </div>
                <div class="mb-3">
                  <label for="confirm-password" class="form-label">Confirm New Password</label>
                  <input type="password" class="form-control" id="confirm-password" required>
                </div>
                <div id="password-error" class="alert alert-danger d-none"></div>
                <button type="submit" class="btn btn-primary">Update Password</button>
              </form>
            </div>
          </div>
          
          <!-- Admin Tab -->
          <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
            <div class="profile-header">
              <h4>Admin Features</h4>
            </div>
            
            <!-- Product Management Section -->
            <div class="admin-section mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Product Management</h4>
                <button class="btn btn-primary" onclick="resetProductForm()" data-bs-toggle="modal" data-bs-target="#productModal">
                  <i class="bi bi-plus-circle me-1"></i> Add Product
                </button>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Image</th>
                      <th>Name</th>
                      <th>Category</th>
                      <th>Price</th>
                      <th>Stock</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="productTableBody">
                    <!-- Product rows will be dynamically added here -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- User Management Section -->
            <div class="admin-section">
              <h4>User Management</h4>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>User</th>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="userTableBody">
                    <!-- User rows will be dynamically added here -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Designer Management Section -->
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Designer Management</h4>
                <button class="btn btn-primary" onclick="resetDesignerForm()" data-bs-toggle="modal" data-bs-target="#designerModal">
                  <i class="bi bi-plus-circle me-1"></i> Add Designer
                </button>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Image</th>
                      <th>Name</th>
                      <th>Specialty</th>
                      <th>Products</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="designerTableBody">
                    <!-- Designer rows will be dynamically added here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">Edit Personal Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="profile-form">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="firstName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="lastName" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="mb-3">
            <label for="birthday" class="form-label">Birthday</label>
            <input type="date" class="form-control" id="birthday" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Gender</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male">
                <label class="form-check-label" for="genderMale">Male</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female">
                <label class="form-check-label" for="genderFemale">Female</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderOther" value="other">
                <label class="form-check-label" for="genderOther">Other</label>
              </div>
            </div>
          </div>
          <div id="profile-error" class="alert alert-danger d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-profile">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="address-form">
          <input type="hidden" id="address-id">
          <div class="mb-3">
            <label for="addressName" class="form-label">Address Name</label>
            <input type="text" class="form-control" id="addressName" placeholder="e.g. Home, Work, etc." required>
          </div>
          <div class="mb-3">
            <label for="fullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" required>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="phone" required>
          </div>
          <div class="mb-3">
            <label for="addressLine1" class="form-label">Address Line 1</label>
            <input type="text" class="form-control" id="addressLine1" required>
          </div>
          <div class="mb-3">
            <label for="addressLine2" class="form-label">Address Line 2 (Optional)</label>
            <input type="text" class="form-control" id="addressLine2">
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="city" class="form-label">City</label>
              <input type="text" class="form-control" id="city" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="state" class="form-label">State/Province</label>
              <input type="text" class="form-control" id="state" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="zipCode" class="form-label">ZIP/Postal Code</label>
              <input type="text" class="form-control" id="zipCode" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <select class="form-select" id="country" required>
              <option value="" selected disabled>Select Country</option>
              <option value="US">United States</option>
              <option value="CA">Canada</option>
              <option value="UK">United Kingdom</option>
              <option value="AU">Australia</option>
              <option value="FR">France</option>
              <option value="DE">Germany</option>
              <option value="JP">Japan</option>
              <option value="CN">China</option>
              <option value="IN">India</option>
              <option value="BR">Brazil</option>
              <option value="MX">Mexico</option>
            </select>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="defaultAddress">
            <label class="form-check-label" for="defaultAddress">
              Set as default shipping address
            </label>
          </div>
          <div id="address-error" class="alert alert-danger d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-address">Save Address</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Address Modal - uses same form as Add Address but with different title -->
<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Will use the same form as addAddressModal -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="update-address">Update Address</button>
      </div>
    </div>
  </div>
</div>

<!-- Designer Modal -->
<div class="modal fade" id="designerModal" tabindex="-1" aria-labelledby="designerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="designerModalLabel">Add New Designer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="designerForm">
          <input type="hidden" id="designerId">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="designerName" class="form-label">Designer Name</label>
                <input type="text" class="form-control" id="designerName" required>
              </div>
              <div class="mb-3">
                <label for="designerSpecialty" class="form-label">Specialty</label>
                <input type="text" class="form-control" id="designerSpecialty" required>
              </div>
              <div class="mb-3">
                <label for="designerBio" class="form-label">Biography</label>
                <textarea class="form-control" id="designerBio" rows="3" required></textarea>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Profile Images</label>
                <div id="designerImagesContainer">
                  <!-- Image previews will be added here -->
                </div>
                <div class="d-grid mt-2">
                  <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('designerImage').click()">
                    <i class="bi bi-upload me-1"></i> Upload Images
                  </button>
                </div>
                <input type="file" id="designerImage" accept="image/*" multiple style="display: none;" onchange="previewDesignerImages(event)">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Social Media Links</label>
            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-instagram"></i></span>
              <input type="url" class="form-control" id="designerInstagram" placeholder="Instagram URL">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-pinterest"></i></span>
              <input type="url" class="form-control" id="designerPinterest" placeholder="Pinterest URL">
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-shop"></i></span>
              <input type="url" class="form-control" id="designerEtsy" placeholder="Etsy URL">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveDesigner()">Save Designer</button>
      </div>
    </div>
  </div>
  </div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="productName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productCategory" class="form-label">Category</label>
                  <select class="form-select" id="productCategory" required>
                    <option value="">Select Category</option>
                    <option value="1">Ceramics</option>
                    <option value="2">Wood Crafts</option>
                    <option value="3">Textiles</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productDesigner" class="form-label">Designer (Optional)</label>
                  <select class="form-select" id="productDesigner">
                    <option value="">No Designer</option>
                    <!-- Designers will be loaded dynamically -->
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productPrice" class="form-label">Price ($)</label>
                  <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productStock" class="form-label">Stock</label>
                  <input type="number" class="form-control" id="productStock" min="0" required>
                </div>
              </div>
              <div class="mb-3">
                <label for="productListingDate" class="form-label">Listing Date</label>
                <input type="datetime-local" class="form-control" id="productListingDate">
              </div>
              <div class="mb-3">
                <label for="productDescription" class="form-label">Description</label>
                <textarea class="form-control" id="productDescription" rows="3" required></textarea>
              </div>
              <div class="mb-3">
                <label for="productDetails" class="form-label">Details</label>
                <textarea class="form-control" id="productDetails" rows="3"></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="productOnSale">
                    <label class="form-check-label" for="productOnSale">On Sale</label>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productSalePrice" class="form-label">Sale Price ($)</label>
                  <input type="number" class="form-control" id="productSalePrice" min="0" step="0.01">
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Product Images</label>
                <div id="productImagesContainer">
                  <!-- Image previews will be added here -->
                </div>
                <div class="d-grid mt-2">
                  <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('productImages').click()">
                    <i class="bi bi-upload me-1"></i> Upload Images
                  </button>
                </div>
                <input type="file" id="productImages" accept="image/*" multiple style="display: none">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">Save Product</button>
      </div>
    </div>
  </div>
</div>

<!-- Product Comments Modal -->
<div class="modal fade" id="productCommentsModal" tabindex="-1" aria-labelledby="productCommentsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productCommentsModalLabel">Product Comments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="productCommentsContainer">
          <!-- Comments will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder" class="mt-5"></div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../assets/js/init-data.js"></script>
  <script>
  // Load navbar and footer
  fetch('../../assets/layout/navbar.html').then(r => r.text()).then(html => document.getElementById('navbar-placeholder').innerHTML = html);
  fetch('../../assets/layout/footer.html').then(r => r.text()).then(html => document.getElementById('footer-placeholder').innerHTML = html);

  // Global variables
  let userProfile = null;
  let userAddresses = [];
  let productsLoaded = false; // 标记产品是否已加载

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded, initializing page...');
    
    // Test localStorage access
    try {
      console.log('Testing localStorage access...');
      const testProducts = JSON.parse(localStorage.getItem('products') || '[]');
      console.log(`Found ${testProducts.length} products in localStorage during initialization`);
      
      const testCategories = JSON.parse(localStorage.getItem('categories') || '[]');
      console.log(`Found ${testCategories.length} categories in localStorage during initialization`);

      const isAdmin = localStorage.getItem('isAdmin') === 'true';
      console.log(`Admin status from localStorage: ${isAdmin}`);
    } catch (error) {
      console.error('Error accessing localStorage:', error);
    }

    if (typeof window.initializeData === 'function') {
      console.log('Initializing data...');
      window.initializeData();
    } else {
      console.warn('initializeData function not found, skipping data initialization');
    }

    loadUserProfile();

    loadUserAddresses();

    initializeAdminFeatures();

    setupEventListeners();
    
    console.log('Page initialization complete.');

    setTimeout(function() {
      if (localStorage.getItem('isAdmin') === 'true') {
        console.log('Forcing admin panel display after page load');
        document.getElementById('admin-tab-container').style.display = 'block';
        if (!productsLoaded) {
          console.log('Products not loaded yet, forcing product load');
          loadProducts();
        }
      }
    }, 1000);
  });

  // Initialize admin features
  function initializeAdminFeatures() {
    console.log('Initializing admin features...');
    // Check if user is admin
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    console.log(`User is admin: ${isAdmin}`);
    
    if (isAdmin) {
      // Show admin tab explicitly
      document.getElementById('admin-tab-container').style.display = 'block';
      console.log('Admin tab container shown');
      
      // Load admin features data
      console.log('Loading admin data...');
      try {
        loadUsers();
        console.log('Users loaded');
        
        loadDesigners();
        console.log('Designers loaded');
        
        console.log('About to load products...');
        loadProducts();
        console.log('Products loaded');
        
        // Setup admin event listeners
        setupAdminEventListeners();
        console.log('Admin event listeners set up');
      } catch (error) {
        console.error('Error loading admin data:', error);
        // 尝试识别和报告具体错误
        if (error.message.includes('getElementById')) {
          console.error('DOM error');
        } else if (error.message.includes('JSON')) {
          console.error('JSON error');
        }
      }
    } else {
      console.log('User is not admin, hiding admin features');
      document.getElementById('admin-tab-container').style.display = 'none';
    }
  }

  // Load user profile from localStorage
  function loadUserProfile() {
    const userData = localStorage.getItem('user');
    if (userData) {
      userProfile = JSON.parse(userData);
      
      // Update profile display
      $('#profile-img').attr('src', userProfile.avatar || '../../assets/img/profile.png');
      $('#user-full-name').text(`${userProfile.firstName} ${userProfile.lastName}`);
      $('#user-email, #email-display').text(userProfile.email);
      
      // Format and display birthday
      const birthday = new Date(userProfile.birthday);
      const formattedBirthday = birthday.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      $('#birthday-display').text(formattedBirthday);
      
      // Display gender
      $('#gender-display').text(userProfile.gender.charAt(0).toUpperCase() + userProfile.gender.slice(1));
      
      // Display first and last name
      $('#first-name').text(userProfile.firstName);
      $('#last-name').text(userProfile.lastName);
      
      // Format and display join date
      const joinDate = new Date(userProfile.createdAt);
      $('#join-date').text(joinDate.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long'
      }));
      
      // Populate edit profile form
      $('#firstName').val(userProfile.firstName);
      $('#lastName').val(userProfile.lastName);
      $('#email').val(userProfile.email);
      $('#birthday').val(userProfile.birthday);
      $(`input[name="gender"][value="${userProfile.gender}"]`).prop('checked', true);
    }
  }

  // Load user addresses from localStorage
  function loadUserAddresses() {
    const addressesData = localStorage.getItem('userAddresses');
    if (addressesData) {
      userAddresses = JSON.parse(addressesData);
      renderAddresses();
    }
  }

  // Render addresses to the addresses container
  function renderAddresses() {
    const container = $('#addresses-container');
    
    if (userAddresses.length === 0) {
      container.html(`
        <div class="no-addresses">
          <i class="bi bi-geo-alt display-4"></i>
          <p class="mt-3">You don't have any saved addresses yet.</p>
        </div>
      `);
      return;
    }
    
    // Sort addresses so default is first
    userAddresses.sort((a, b) => (b.isDefault ? 1 : 0) - (a.isDefault ? 1 : 0));
    
    let addressesHTML = '';
    userAddresses.forEach((address, index) => {
      addressesHTML += `
        <div class="address-card ${address.isDefault ? 'default' : ''}">
          ${address.isDefault ? '<div class="default-badge">Default</div>' : ''}
          <h5>${address.name}</h5>
          <div>${address.fullName}</div>
          <div>${address.phone}</div>
          <div>${address.addressLine1}</div>
          ${address.addressLine2 ? `<div>${address.addressLine2}</div>` : ''}
          <div>${address.city}, ${address.state} ${address.zipCode}</div>
          <div>${getCountryName(address.country)}</div>
          
          <div class="address-actions">
            <button class="btn btn-sm btn-outline-primary edit-address" data-index="${index}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            ${!address.isDefault ? `
              <button class="btn btn-sm btn-outline-success set-default" data-index="${index}">
                Set as Default
              </button>
            ` : ''}
            <button class="btn btn-sm btn-outline-danger delete-address" data-index="${index}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        </div>
      `;
    });
    
    container.html(addressesHTML);
    
    // Add event listeners to address action buttons
    $('.edit-address').click(function() {
      const index = $(this).data('index');
      editAddress(index);
    });
    
    $('.set-default').click(function() {
      const index = $(this).data('index');
      setDefaultAddress(index);
    });
    
    $('.delete-address').click(function() {
      const index = $(this).data('index');
      deleteAddress(index);
    });
  }

  // Setup event listeners
  function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Profile photo upload
    $('#avatar-upload').change(updateProfilePhoto);
    
    // Save profile changes
    $('#save-profile').click(saveProfileChanges);
    
    // Save new address
    $('#save-address').click(saveNewAddress);
    
    // Change password form
    $('#change-password-form').submit(function(e) {
      e.preventDefault();
      changePassword();
    });
    
    // Copy address form to edit modal
    $('#editAddressModal').on('show.bs.modal', function() {
      $(this).find('.modal-body').html($('#addAddressModal .modal-body').html());
    });
    
    // Add product event listeners
    $('#productImages').change(function(event) {
      previewProductImages(event);
    });

    $('#saveProductBtn').click(function() {
      console.log('Save product button clicked');
      saveProduct();
    });

    $('.btn[data-bs-toggle="modal"][data-bs-target="#productModal"]').click(function() {
      console.log('Add product button clicked, resetting form');
      resetProductForm();
    });

    $('#productModal').on('show.bs.modal', function() {
      console.log('Product modal opened, loading designers...');
      loadDesignersForProduct();
    });
    
    console.log('Event listeners setup complete.');
  }

  // Update profile photo
      function updateProfilePhoto(event) {
          const file = event.target.files[0];
          if (file && (file.type === "image/jpeg" || file.type === "image/png")) {
      if (file.size > 5 * 1024 * 1024) {
        alert("Image size should not exceed 5MB");
        return;
      }
      
              const reader = new FileReader();
      reader.onload = function(e) {
        const imgData = e.target.result;
        $('#profile-img').attr('src', imgData);
        
        // Update user profile in localStorage
        if (userProfile) {
          userProfile.avatar = imgData;
          localStorage.setItem('user', JSON.stringify(userProfile));
        }
              };
              reader.readAsDataURL(file);
          } else {
              alert("Please upload a valid JPG or PNG image.");
          }
      }

  // Save profile changes
  function saveProfileChanges() {
    const firstName = $('#firstName').val().trim();
    const lastName = $('#lastName').val().trim();
    const email = $('#email').val().trim();
    const birthday = $('#birthday').val();
    const gender = $('input[name="gender"]:checked').val();
    
    // Validate form
    if (!firstName || !lastName || !email || !birthday || !gender) {
      $('#profile-error').text('Please fill in all required fields.').removeClass('d-none');
      return;
    }
    
    // Update user profile
    userProfile = {
      ...userProfile,
      firstName,
      lastName,
      email,
      birthday,
      gender
    };
    
    // Save to localStorage
    localStorage.setItem('user', JSON.stringify(userProfile));
    
    // Update display
    loadUserProfile();
    
    // Close modal
    $('#editProfileModal').modal('hide');
    
    // Show success message
    alert('Profile updated successfully!');
  }

  // Save new address
  function saveNewAddress() {
    const addressId = $('#address-id').val();
    const name = $('#addressName').val().trim();
    const fullName = $('#fullName').val().trim();
    const phone = $('#phone').val().trim();
    const addressLine1 = $('#addressLine1').val().trim();
    const addressLine2 = $('#addressLine2').val().trim();
    const city = $('#city').val().trim();
    const state = $('#state').val().trim();
    const zipCode = $('#zipCode').val().trim();
    const country = $('#country').val();
    const isDefault = $('#defaultAddress').is(':checked');
    
    // Validate form
    if (!name || !fullName || !phone || !addressLine1 || !city || !state || !zipCode || !country) {
      $('#address-error').text('Please fill in all required fields.').removeClass('d-none');
      return;
    }
    
    // Create address object
    const newAddress = {
      id: addressId || new Date().getTime().toString(),
      name,
      fullName,
      phone,
      addressLine1,
      addressLine2,
      city,
      state,
      zipCode,
      country,
      isDefault
    };
    
    // If this is set as default, remove default from other addresses
    if (isDefault) {
      userAddresses.forEach(addr => addr.isDefault = false);
    }
    
    // Check if we're editing an existing address
    const existingIndex = userAddresses.findIndex(addr => addr.id === newAddress.id);
    if (existingIndex >= 0) {
      // Update existing address
      userAddresses[existingIndex] = newAddress;
    } else {
      // Add new address
      // If this is the first address, make it default
      if (userAddresses.length === 0) {
        newAddress.isDefault = true;
      }
      userAddresses.push(newAddress);
    }
    
    // Save to localStorage
    localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
    
    // Update shipping cost in cart if this is default address
    if (newAddress.isDefault) {
      updateCartShippingCost(newAddress);
    }
    
    // Render addresses
    renderAddresses();
    
    // Reset form
    $('#address-form')[0].reset();
    $('#address-id').val('');
    
    // Close modal
    $('#addAddressModal').modal('hide');
    $('#editAddressModal').modal('hide');
    
    // Show success message
    alert('Address saved successfully!');
  }

  // Edit address
  function editAddress(index) {
    const address = userAddresses[index];
    
    // Populate form
    $('#address-id').val(address.id);
    $('#addressName').val(address.name);
    $('#fullName').val(address.fullName);
    $('#phone').val(address.phone);
    $('#addressLine1').val(address.addressLine1);
    $('#addressLine2').val(address.addressLine2);
    $('#city').val(address.city);
    $('#state').val(address.state);
    $('#zipCode').val(address.zipCode);
    $('#country').val(address.country);
    $('#defaultAddress').prop('checked', address.isDefault);
    
    // Show modal
    $('#editAddressModal').modal('show');
    
    // Set update button event handler
    $('#update-address').off('click').on('click', saveNewAddress);
  }

  // Set default address
  function setDefaultAddress(index) {
    // Set all addresses to non-default
    userAddresses.forEach(addr => addr.isDefault = false);
    
    // Set selected address as default
    userAddresses[index].isDefault = true;
    
    // Update shipping cost in cart
    updateCartShippingCost(userAddresses[index]);
    
    // Save to localStorage
    localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
    
    // Render addresses
    renderAddresses();
    
    // Show success message
    alert('Default address updated successfully!');
  }

  // Delete address
  function deleteAddress(index) {
    if (!confirm('Are you sure you want to delete this address?')) {
      return;
    }
    
    const wasDefault = userAddresses[index].isDefault;
    
    // Remove address
    userAddresses.splice(index, 1);
    
    // If deleted address was default and there are other addresses, set first as default
    if (wasDefault && userAddresses.length > 0) {
      userAddresses[0].isDefault = true;
      updateCartShippingCost(userAddresses[0]);
    }
    
    // Save to localStorage
    localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
    
    // Render addresses
    renderAddresses();
  }

  // Update cart shipping cost based on default address
  function updateCartShippingCost(address) {
    // Simple shipping cost calculation example
    let shippingCost = 5.99; // Default shipping cost
    
    // Adjust based on country
    if (address.country === 'US') {
      shippingCost = 5.99;
    } else if (['CA', 'MX'].includes(address.country)) {
      shippingCost = 9.99;
    } else {
      shippingCost = 14.99;
    }
    
    // Save shipping cost to localStorage for cart to use
    localStorage.setItem('shippingCost', shippingCost.toString());
    
    return shippingCost;
  }

  // Change password
  function changePassword() {
    const currentPassword = $('#current-password').val();
    const newPassword = $('#new-password').val();
    const confirmPassword = $('#confirm-password').val();
    
    // Validate passwords
    if (!currentPassword || !newPassword || !confirmPassword) {
      $('#password-error').text('Please fill in all password fields.').removeClass('d-none');
      return;
    }
    
    if (newPassword !== confirmPassword) {
      $('#password-error').text('New passwords do not match.').removeClass('d-none');
      return;
    }
    
    if (newPassword.length < 8) {
      $('#password-error').text('New password must be at least 8 characters long.').removeClass('d-none');
      return;
    }
    
    // Check if current password is correct
    if (userProfile && userProfile.password !== currentPassword) {
      $('#password-error').text('Current password is incorrect.').removeClass('d-none');
      return;
    }
    
    // Update password
    if (userProfile) {
      userProfile.password = newPassword;
      localStorage.setItem('user', JSON.stringify(userProfile));
      
      // Reset form
      $('#change-password-form')[0].reset();
      $('#password-error').addClass('d-none');
      
      // Show success message
      alert('Password changed successfully!');
    }
  }

  // Helper function to get country name from code
  function getCountryName(countryCode) {
    const countries = {
      'US': 'United States',
      'CA': 'Canada',
      'UK': 'United Kingdom',
      'AU': 'Australia',
      'FR': 'France',
      'DE': 'Germany',
      'JP': 'Japan',
      'CN': 'China',
      'IN': 'India',
      'BR': 'Brazil',
      'MX': 'Mexico'
    };
    
    return countries[countryCode] || countryCode;
  }

  // Load users
  function loadUsers() {
    let users = JSON.parse(localStorage.getItem("usersData")) || [
      { id: 1, name: "Alice", email: "alice@example.com", status: "Active" },
      { id: 2, name: "Bob", email: "bob@example.com", status: "Disabled" }
    ];

    let userTable = document.getElementById("userTableBody");
    userTable.innerHTML = "";

    users.forEach(user => {
      userTable.innerHTML += `
        <tr>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.status}</td>
          <td>
            ${user.status === "Active" ? 
              `<button class="disable-btn" onclick="toggleUserStatus(${user.id}, 'Disabled')">Disable</button>` :
              `<button class="enable-btn" onclick="toggleUserStatus(${user.id}, 'Active')">Enable</button>`
            }
          </td>
        </tr>`;
    });

    localStorage.setItem("usersData", JSON.stringify(users));
  }

  // Toggle user status
  function toggleUserStatus(userId, newStatus) {
    let users = JSON.parse(localStorage.getItem("usersData"));

    let userIndex = users.findIndex(user => user.id === userId);
    if (userIndex !== -1) {
      users[userIndex].status = newStatus;
      localStorage.setItem("usersData", JSON.stringify(users));
      loadUsers();
    }
  }

  // Load orders
  function loadOrders() {
    let orders = JSON.parse(localStorage.getItem("ordersData")) || [
      { id: 101, product: "Handmade Soap", amount: "$50", orderStatus: "New" },
      { id: 102, product: "Handmade Candle", amount: "$30", orderStatus: "Packed" },
      { id: 103, product: "Handmade Basket", amount: "$45", orderStatus: "InTransit" },
      { id: 104, product: "Handmade Vase", amount: "$60", orderStatus: "Delivered" }
    ];

    // Update order counts
    document.getElementById("new-count").textContent = orders.filter(order => order.orderStatus === "New").length;
    document.getElementById("packed-count").textContent = orders.filter(order => order.orderStatus === "Packed").length;
    document.getElementById("transit-count").textContent = orders.filter(order => order.orderStatus === "InTransit").length;
    document.getElementById("delivered-count").textContent = orders.filter(order => order.orderStatus === "Delivered").length;

    // Render order list
    let orderList = document.getElementById("order-list");
    orderList.innerHTML = "";

    orders.forEach(order => {
      orderList.innerHTML += `
        <tr>
          <td>${order.id}</td>
          <td>${order.product}</td>
          <td>${order.amount}</td>
          <td>${order.orderStatus}</td>
          <td>
            <div class="btn-group">
              <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'New')">New</button>
              <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'Packed')">Packed</button>
              <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'InTransit')">In Transit</button>
              <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'Delivered')">Delivered</button>
              <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.id})">Delete</button>
            </div>
          </td>
        </tr>`;
    });

    localStorage.setItem("ordersData", JSON.stringify(orders));
  }

  // Update order status
  function updateOrderStatus(orderId, newStatus) {
    let orders = JSON.parse(localStorage.getItem("ordersData"));
    
    let orderIndex = orders.findIndex(order => order.id === orderId);
    if (orderIndex !== -1) {
      orders[orderIndex].orderStatus = newStatus;
      localStorage.setItem("ordersData", JSON.stringify(orders));
      loadOrders();
    }
  }

  // Delete order
  function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order?')) {
      let orders = JSON.parse(localStorage.getItem("ordersData"));
      orders = orders.filter(order => order.id !== orderId);
      localStorage.setItem("ordersData", JSON.stringify(orders));
      loadOrders();
    }
  }

  // Load comments
  function loadComments() {
    let comments = JSON.parse(localStorage.getItem("commentsData")) || [
      { id: 1, author: "Lisa", rating: 5, text: "Great product, excellent quality!" },
      { id: 2, author: "Mike", rating: 4, text: "Beautiful packaging, very thoughtful." },
      { id: 3, author: "Sarah", rating: 5, text: "My friend loved this gift!" }
    ];

    let commentList = document.getElementById("comment-list");
    commentList.innerHTML = "";

    comments.forEach(comment => {
      commentList.innerHTML += `
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${comment.author}</strong>
              <span class="text-warning">
                ${"★".repeat(comment.rating)}${"☆".repeat(5 - comment.rating)}
              </span>
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteComment(${comment.id})">Delete</button>
          </div>
          <p class="mb-0 mt-2">${comment.text}</p>
        </li>`;
    });

    localStorage.setItem("commentsData", JSON.stringify(comments));
  }

  // Delete comment
  function deleteComment(commentId) {
    if (confirm('Are you sure you want to delete this comment?')) {
      let comments = JSON.parse(localStorage.getItem("commentsData"));
      comments = comments.filter(comment => comment.id !== commentId);
      localStorage.setItem("commentsData", JSON.stringify(comments));
      loadComments();
    }
  }

  // Setup admin event listeners
  function setupAdminEventListeners() {
    // User search
    $('#search-user').click(function() {
      const searchTerm = $('#user-search').val().trim().toLowerCase();
      if (searchTerm) {
        const users = JSON.parse(localStorage.getItem("usersData") || "[]");
        // Filter users by ID or email
        const filteredUsers = users.filter(user => 
          user.id.toString().includes(searchTerm) || 
          user.email.toLowerCase().includes(searchTerm)
        );
        
        if (filteredUsers.length > 0) {
          renderFilteredUsers(filteredUsers);
        } else {
          alert('No users found matching your search');
        }
      } else {
        loadUsers(); // Reset to show all users if search is empty
      }
    });

    // Reset user list when clearing search box
    $('#user-search').on('input', function() {
      if ($(this).val().trim() === '') {
        loadUsers();
      }
    });

    // Order search
    $('#check-order').click(function() {
      const orderId = parseInt($('#order-search').val());
      if (!isNaN(orderId)) {
        const orders = JSON.parse(localStorage.getItem("ordersData") || "[]");
        const order = orders.find(o => o.id === orderId);
        if (order) {
          alert(`Order ID: ${order.id}\nProduct: ${order.product}\nAmount: ${order.amount}\nStatus: ${order.orderStatus}`);
        } else {
          alert('Order not found');
        }
      } else {
        alert('Please enter a valid Order ID');
      }
    });

    // Order filter
    $('.order-filter').click(function() {
      const status = $(this).data('status');
      const orders = JSON.parse(localStorage.getItem("ordersData") || "[]");
      const filteredOrders = status ? orders.filter(o => o.orderStatus === status) : orders;
      
      let orderList = document.getElementById("order-list");
      orderList.innerHTML = "";

      filteredOrders.forEach(order => {
        orderList.innerHTML += `
          <tr>
            <td>${order.id}</td>
            <td>${order.product}</td>
            <td>${order.amount}</td>
            <td>${order.orderStatus}</td>
            <td>
              <div class="btn-group">
                <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'New')">New</button>
                <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'Packed')">Packed</button>
                <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'InTransit')">In Transit</button>
                <button class="admin-status-btn" onclick="updateOrderStatus(${order.id}, 'Delivered')">Delivered</button>
                <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.id})">Delete</button>
              </div>
            </td>
          </tr>`;
      });
    });
  }

  // Render filtered users
  function renderFilteredUsers(users) {
    let userTable = document.getElementById("userTableBody");
    userTable.innerHTML = "";

    users.forEach(user => {
      userTable.innerHTML += `
        <tr>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.status}</td>
          <td>
            ${user.status === "Active" ? 
              `<button class="disable-btn" onclick="toggleUserStatus(${user.id}, 'Disabled')">Disable</button>` :
              `<button class="enable-btn" onclick="toggleUserStatus(${user.id}, 'Active')">Enable</button>`
            }
          </td>
        </tr>`;
    });
  }

  // Designer management functions
  function loadDesigners() {
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const tableBody = document.getElementById('designerTableBody');
    
    tableBody.innerHTML = designers.map(designer => {
      const designerProducts = products.filter(p => p.designerId === designer.id);
      return `
        <tr>
          <td>
            <img src="${designer.image}" alt="${designer.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">
          </td>
          <td>${designer.name}</td>
          <td>${designer.specialty}</td>
          <td>${designerProducts.length} products</td>
          <td>
            <button class="btn btn-sm btn-primary me-1" onclick="editDesigner('${designer.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger me-1" onclick="deleteDesigner('${designer.id}')">
              <i class="bi bi-trash"></i>
            </button>
            <a href="/src/views/designer-page.html?id=${designer.id}" class="btn btn-sm btn-info" target="_blank">
              <i class="bi bi-eye"></i>
            </a>
          </td>
        </tr>
      `;
    }).join('');
  }

  function previewDesignerImages(event) {
    const container = document.getElementById('designerImagesContainer');
    const files = event.target.files;
    
    if (files.length === 0) return;
    
    // Clear existing previews when adding new images
    container.innerHTML = '';
    
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        container.innerHTML += `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `;
      };
      reader.readAsDataURL(file);
    });
  }

  function resetDesignerForm() {
    document.getElementById('designerForm').reset();
    document.getElementById('designerId').value = '';
    document.getElementById('designerImagesContainer').innerHTML = '';
    document.getElementById('designerModalLabel').textContent = 'Add New Designer';
  }

  function editDesigner(id) {
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    const designer = designers.find(d => d.id === id);
    
    if (designer) {
      document.getElementById('designerId').value = designer.id;
      document.getElementById('designerName').value = designer.name;
      document.getElementById('designerSpecialty').value = designer.specialty;
      document.getElementById('designerBio').value = designer.bio;
      document.getElementById('designerInstagram').value = designer.social.instagram || '';
      document.getElementById('designerPinterest').value = designer.social.pinterest || '';
      document.getElementById('designerEtsy').value = designer.social.etsy || '';
      
      const container = document.getElementById('designerImagesContainer');
      container.innerHTML = '';
      
      // Display main image and any additional images
      if (designer.image) {
        container.innerHTML += `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${designer.image}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `;
      }
      
      // Add additional images if they exist
      if (designer.images && designer.images.length > 1) {
        designer.images.slice(1).forEach(img => {
          container.innerHTML += `
            <div class="position-relative d-inline-block me-2 mb-2">
              <img src="${img}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
              <button type="button" class="btn-close position-absolute top-0 end-0" 
                style="background-color: white;" onclick="this.parentElement.remove()"></button>
            </div>
          `;
        });
      }
      
      document.getElementById('designerModalLabel').textContent = 'Edit Designer';
      new bootstrap.Modal(document.getElementById('designerModal')).show();
    }
  }

  function saveDesigner() {
    const designerId = document.getElementById('designerId').value;
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    
    // Get all images from the container
    const images = Array.from(document.getElementById('designerImagesContainer').children || [])
      .map(div => div.querySelector('img').src);
    
    const mainImage = images.length > 0 ? images[0] : '../../assets/img/placeholder.png';
    
    const designer = {
      id: designerId || `d${Date.now()}`,
      name: document.getElementById('designerName').value,
      specialty: document.getElementById('designerSpecialty').value,
      bio: document.getElementById('designerBio').value,
      image: mainImage,
      images: images,
      social: {
        instagram: document.getElementById('designerInstagram').value,
        pinterest: document.getElementById('designerPinterest').value,
        etsy: document.getElementById('designerEtsy').value
      }
    };
    
    if (designerId) {
      const index = designers.findIndex(d => d.id === designerId);
      if (index !== -1) {
        designers[index] = designer;
      }
    } else {
      designers.push(designer);
    }
    
    localStorage.setItem('designers', JSON.stringify(designers));
    bootstrap.Modal.getInstance(document.getElementById('designerModal')).hide();
    loadDesigners();
  }

  function deleteDesigner(id) {
    if (confirm('Are you sure you want to delete this designer? This will not delete their products.')) {
      const designers = JSON.parse(localStorage.getItem('designers') || '[]');
      const filteredDesigners = designers.filter(d => d.id !== id);
      localStorage.setItem('designers', JSON.stringify(filteredDesigners));
      loadDesigners();
    }
  }

  // Product management functions
  function loadProducts() {
    console.log('Loading products...');
    try {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      console.log(`Found ${products.length} products in localStorage`);
      
      const categories = JSON.parse(localStorage.getItem('categories') || '[]');
      console.log(`Found ${categories.length} categories in localStorage`);
      
      const designers = JSON.parse(localStorage.getItem('designers') || '[]');
      console.log(`Found ${designers.length} designers in localStorage`);
      
      const tableBody = document.getElementById('productTableBody');
      if (!tableBody) {
        console.error('productTableBody element not found! DOM may not be fully loaded.');
        // 尝试延迟后再次加载
        setTimeout(function() {
          const retryTableBody = document.getElementById('productTableBody');
          if (retryTableBody) {
            console.log('Found productTableBody on retry');
            fillProductTable(retryTableBody, products, categories, designers);
          } else {
            console.error('productTableBody still not found after retry');
          }
        }, 1000);
        return;
      }
      
      fillProductTable(tableBody, products, categories, designers);
      productsLoaded = true;
    } catch (error) {
      console.error('Error loading products:', error);
    }
  }

  // 将填充表格功能独立为函数，方便复用
  function fillProductTable(tableBody, products, categories, designers) {
    tableBody.innerHTML = '';  // 清空表格
    console.log(`Filling table with ${products.length} products`);
    
    if (products.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="7" class="text-center">没有找到产品</td></tr>';
      return;
    }
    
    products.forEach(product => {
      console.log(`Processing product: ${product.name}, format:`, product);
      
      // 兼容两种数据格式
      let categoryName = 'Unknown';
      if (product.categoryId) {
        // 第一种格式：使用categoryId关联categories数组
        const category = categories.find(c => c.id === product.categoryId);
        if (category) {
          categoryName = category.name;
        }
      } else if (product.category) {
        // 第二种格式：直接使用category字段
        categoryName = product.category;
      }
      
      const designer = product.designerId ? designers.find(d => d.id === product.designerId) : null;
      
      // 兼容两种图片格式
      let mainImage = '../../assets/img/placeholder.png';
      if (product.images && product.images.length > 0) {
        mainImage = product.images[0];
      }
      
      // 检查是否是新品（上架时间在一个月内）
      const isNew = product.listingDate && 
        (new Date().getTime() - new Date(product.listingDate).getTime()) <= 30 * 24 * 60 * 60 * 1000;
      
      // 兼容不同的价格格式
      const price = typeof product.price === 'number' ? product.price : parseFloat(product.price) || 0;
      const salePrice = product.salePrice || (product.onSale ? price * 0.9 : null);
      const stock = product.stock || 10; // 如果没有库存信息，默认为10
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <img src="${mainImage}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;">
        </td>
        <td>
          ${product.name}
          ${isNew ? '<span class="badge bg-info ms-1">New</span>' : ''}
        </td>
        <td>${categoryName}</td>
        <td>$${price.toFixed(2)}${product.onSale ? `<br><span class="text-danger">Sale: $${salePrice.toFixed(2)}</span>` : ''}</td>
        <td>${stock}</td>
        <td>
          ${product.onSale ? '<span class="badge bg-danger">On Sale</span>' : '<span class="badge bg-success">Regular</span>'}
          <br>
          <small class="text-muted">Listed: ${product.listingDate ? new Date(product.listingDate).toLocaleDateString() : 'N/A'}</small>
        </td>
        <td>
          <div class="btn-group">
            <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${product.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-danger me-1" onclick="deleteProduct('${product.id}')">
              <i class="bi bi-trash"></i>
            </button>
            <button class="btn btn-sm btn-info" onclick="viewProductComments('${product.id}')">
              <i class="bi bi-chat-dots"></i>
            </button>
          </div>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function loadDesignersForProduct() {
    console.log('Loading designers for product dropdown');
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    const select = document.getElementById('productDesigner');
    
    if (!select) {
      console.error('productDesigner select element not found');
      return;
    }
    
    select.innerHTML = '<option value="">Select Designer</option>' + 
      designers.map(designer => `
        <option value="${designer.id}">${designer.name} (${designer.specialty})</option>
      `).join('');
    
    console.log(`Loaded ${designers.length} designers into dropdown`);
  }

  function previewProductImages(event) {
    const container = document.getElementById('productImagesContainer');
    const files = event.target.files;
    
    if (!container) {
      console.error('productImagesContainer element not found');
      return;
    }
    
    container.innerHTML = '';
    
    if (files.length === 0) {
      console.log('No files selected for preview');
      return;
    }
    
    console.log(`Previewing ${files.length} product images`);
    
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        container.innerHTML += `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `;
      };
      reader.readAsDataURL(file);
    });
  }

  function resetProductForm() {
    console.log('Resetting product form');
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productImagesContainer').innerHTML = '';
    document.getElementById('productModalLabel').textContent = 'Add New Product';
    loadDesignersForProduct();
  }

  function editProduct(id) {
    console.log(`Editing product with ID: ${id}`);
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const product = products.find(p => p.id === parseInt(id) || p.id === id);
    
    if (product) {
      document.getElementById('productId').value = product.id;
      document.getElementById('productName').value = product.name;
      
      // 兼容两种分类格式
      if (product.categoryId) {
        document.getElementById('productCategory').value = product.categoryId;
      } else if (product.category) {
        // 尝试根据分类名称找到分类ID
        const categories = JSON.parse(localStorage.getItem('categories') || '[]');
        const category = categories.find(c => c.name === product.category);
        if (category) {
          document.getElementById('productCategory').value = category.id;
        }
      }
      
      document.getElementById('productDesigner').value = product.designerId || '';
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productStock').value = product.stock || 10;
      document.getElementById('productDescription').value = product.description;
      
      // 兼容不同的details格式
      const details = product.details || product.description || '';
      document.getElementById('productDetails').value = details.replace ? details.replace(/<br>/g, '\n') : details;
      
      document.getElementById('productOnSale').checked = product.onSale || false;
      document.getElementById('productSalePrice').value = product.salePrice || '';
      
      // 设置上架时间
      if (product.listingDate) {
        const date = new Date(product.listingDate);
        const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
        document.getElementById('productListingDate').value = localDateTime;
      } else {
        document.getElementById('productListingDate').value = '';
      }
      
      const container = document.getElementById('productImagesContainer');
      container.innerHTML = '';
      
      // 兼容不同的图片格式
      if (product.images && product.images.length > 0) {
        container.innerHTML = product.images.map(image => `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${image}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `).join('');
      }
      
      document.getElementById('productModalLabel').textContent = 'Edit Product';
      loadDesignersForProduct();
      
      console.log('Opening product modal for editing');
      new bootstrap.Modal(document.getElementById('productModal')).show();
    } else {
      console.error(`Product with ID ${id} not found`);
    }
  }

  function saveProduct() {
    console.log('Saving product...');
    const productId = document.getElementById('productId').value;
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    
    try {
      // 获取表单数据
      const productName = document.getElementById('productName').value;
      const productCategory = document.getElementById('productCategory').value;
      const productPrice = document.getElementById('productPrice').value;
      
      if (!productName || !productCategory || !productPrice) {
        console.error('Missing required product fields');
        alert('请填写所有必填字段：商品名称、分类和价格');
        return;
      }
      
      console.log(`Collecting data for product: ${productName}`);
      
      const imagesContainer = document.getElementById('productImagesContainer');
      if (!imagesContainer) {
        console.error('productImagesContainer not found');
        return;
      }
      
      const images = Array.from(imagesContainer.querySelectorAll('img')).map(img => img.src);
      console.log(`Found ${images.length} images for product`);
      
      const designerId = document.getElementById('productDesigner').value;
      
      // 获取上架时间，如果没有设置则使用当前时间
      const listingDateInput = document.getElementById('productListingDate').value;
      const listingDate = listingDateInput ? new Date(listingDateInput).toISOString() 
        : productId ? (products.find(p => p.id === parseInt(productId) || p.id === productId)?.listingDate || new Date().toISOString())
        : new Date().toISOString();
      
      // 为新产品生成唯一ID
      let newId;
      if (productId) {
        newId = parseInt(productId) || productId;
      } else {
        // 生成唯一ID的更可靠方法
        const numericIds = products
          .map(p => typeof p.id === 'number' ? p.id : parseInt(p.id))
          .filter(id => !isNaN(id));
        
        newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : 1;
      }
      
      console.log(`Using product ID: ${newId}`);
      
      // 获取分类信息
      const categories = JSON.parse(localStorage.getItem('categories') || '[]');
      const selectedCategory = categories.find(c => c.id === parseInt(productCategory));
      
      const product = {
        id: newId,
        name: productName,
        categoryId: parseInt(productCategory),
        category: selectedCategory ? selectedCategory.name : null, // 同时存储分类名称，兼容两种格式
        designerId: designerId || null,
        price: parseFloat(productPrice),
        stock: parseInt(document.getElementById('productStock').value) || 0,
        description: document.getElementById('productDescription').value,
        details: document.getElementById('productDetails').value.replace(/\n/g, '<br>'),
        onSale: document.getElementById('productOnSale').checked,
        salePrice: document.getElementById('productSalePrice').value ? 
          parseFloat(document.getElementById('productSalePrice').value) : null,
        images: images.length > 0 ? images : ['../../assets/img/placeholder.png'], // 确保至少有一张默认图片
        listingDate: listingDate,
        reviews: productId ? 
          (products.find(p => p.id === parseInt(productId) || p.id === productId)?.reviews || []) : []
      };
      
      console.log(`Prepared product data:`, JSON.stringify(product, null, 2));
      
      if (productId) {
        console.log(`Updating existing product with ID: ${productId}`);
        const index = products.findIndex(p => p.id === parseInt(productId) || p.id === productId);
        if (index !== -1) {
          products[index] = product;
        } else {
          console.error(`Product with ID ${productId} not found for update`);
          products.push(product);
        }
      } else {
        console.log('Adding new product');
        products.push(product);
      }

      console.log(`Saving products to localStorage, total: ${products.length}`);
      
      localStorage.setItem('products', JSON.stringify(products));
      console.log(`Successfully saved product. Total products: ${products.length}`);

      const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
      if (modal) {
        modal.hide();
      } else {
        console.error('Could not find modal instance');
        document.getElementById('productModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
      }

      loadProducts();
      
      alert('Product saved！');
    } catch (error) {
      console.error('Error saving product:', error);
      alert('error: ' + error.message);
    }
  }

  function deleteProduct(id) {
    console.log(`Attempting to delete product with ID: ${id}`);
    if (confirm('Delete this product？')) {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      const filteredProducts = products.filter(p => p.id !== parseInt(id) && p.id !== id);
      
      if (filteredProducts.length < products.length) {
        localStorage.setItem('products', JSON.stringify(filteredProducts));
        console.log(`Product deleted. Remaining products: ${filteredProducts.length}`);
        loadProducts();
      } else {
        console.error(`No product found with ID ${id} to delete`);
      }
    }
  }

  // 添加缺失的viewProductComments函数
  function viewProductComments(productId) {
    console.log(`Viewing comments for product with ID: ${productId}`);
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const product = products.find(p => p.id === parseInt(productId) || p.id === productId);
    
    if (product) {
      const container = document.getElementById('productCommentsContainer');
      const reviews = product.reviews || [];
      
      container.innerHTML = `
        <h6 class="mb-3">Comments for "${product.name}"</h6>
        ${reviews.length === 0 ? '<p class="text-muted">No comments yet.</p>' : ''}
        <div class="list-group">
          ${reviews.map(review => `
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">${review.name}</h6>
                  <div class="text-warning mb-1">
                    ${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}
                  </div>
                </div>
                <div>
                  <button class="btn btn-sm btn-primary me-1" onclick="editComment('${productId}', '${review.name}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteComment('${productId}', '${review.name}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <p class="mb-1">${review.comment}</p>
              <small class="text-muted">${new Date(review.date).toLocaleDateString()}</small>
            </div>
          `).join('')}
        </div>
      `;
      
      new bootstrap.Modal(document.getElementById('productCommentsModal')).show();
    }
  }

  function editComment(productId, reviewerName) {
    console.log(`Editing comment for product ${productId} by ${reviewerName}`);
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const product = products.find(p => p.id === parseInt(productId) || p.id === productId);
    
    if (product) {
      const review = product.reviews.find(r => r.name === reviewerName);
      if (review) {
        const newComment = prompt('Edit comment:', review.comment);
        if (newComment !== null) {
          review.comment = newComment;
          localStorage.setItem('products', JSON.stringify(products));
          viewProductComments(productId);
        }
      }
    }
  }

  function deleteComment(productId, reviewerName) {
    console.log(`Deleting comment for product ${productId} by ${reviewerName}`);
    if (confirm('Are you sure you want to delete this comment?')) {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      const product = products.find(p => p.id === parseInt(productId) || p.id === productId);
      
      if (product) {
        product.reviews = product.reviews.filter(r => r.name !== reviewerName);
        localStorage.setItem('products', JSON.stringify(products));
        viewProductComments(productId);
      }
    }
  }

  window.editProduct = editProduct;
  window.deleteProduct = deleteProduct;
  window.viewProductComments = viewProductComments;
  window.resetProductForm = resetProductForm;
  window.saveProduct = saveProduct;
  window.editComment = editComment;
  window.deleteComment = deleteComment;
  </script>

</body>
</html>
