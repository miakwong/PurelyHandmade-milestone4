<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shopping Cart - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../../css/styles.css" rel="stylesheet">
  <style>
    .cart-container {
      background-color: #f8f9fa;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .cart-item {
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
      transition: opacity 0.3s;
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item-unchecked {
      opacity: 0.6;
    }

    .cart-item-checkbox {
      transform: scale(1.2);
      cursor: pointer;
      accent-color: var(--accent-color);
    }

    .cart-summary {
      background-color: #f8f9fa;
      border-radius: 0.25rem;
      padding: 1.25rem;
      margin-top: 1.5rem;
      border: 1px solid #dee2e6;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .summary-total {
      border-top: 1px solid #dee2e6;
      margin-top: 1rem;
      padding-top: 1rem;
      font-weight: bold;
    }

    .product-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
    }

    .btn-quantity {
      width: 30px;
      height: 30px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .quantity-input {
      width: 50px;
      text-align: center;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 0.25rem;
    }

    .empty-cart-message {
      padding: 3rem;
      text-align: center;
    }

    .select-all-container {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #dee2e6;
    }
  </style>
</head>

<body>
  <!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

  <div class="container my-5">
    <h2 class="mb-4 text-center">Shopping Cart</h2>

    <div class="row">
      <div class="col-lg-8">
        <div class="cart-container">
          <div id="cart-items-container">
            <!-- Cart items will be loaded here -->
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="cart-summary">
          <h4 class="mb-3">Order Summary</h4>

          <div class="summary-item">
            <span>Subtotal:</span>
            <span id="subtotal">$0.00</span>
          </div>
          <div class="summary-item">
            <span>Estimated Shipping:</span>
            <span id="shipping-cost">$5.99</span>
          </div>
          <div class="summary-item summary-total">
            <span>Total:</span>
            <span id="total-cost">$0.00</span>
          </div>

          <div class="d-grid gap-2 mt-3">
            <button id="checkout-btn" class="btn btn-success btn-lg" disabled>Proceed to Checkout</button>
            <a href="../../index.html" id="continue-shopping"
              class="btn btn-outline-secondary text-decoration-none d-flex justify-content-center align-items-center"
              style="height: 48px;">Continue Shopping</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Footer Placeholder -->
  <div id="footer-placeholder" class="mt-5"></div>

  <!-- Core Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Configuration and API -->
  <script src="../../js/config.js"></script>
  <script src="../../js/api-client.js"></script>

  <!-- Application Logic -->
  <script src="../../js/ui.js"></script>
  <script src="../../js/cart.js"></script>

  <script>
    // Load layout components
    document.addEventListener('DOMContentLoaded', function () {
      // Load navbar and footer using the correct paths
      fetch('../../layout/navbar.html')
        .then(response => response.text())
        .then(html => document.getElementById('navbar-placeholder').innerHTML = html)
        .catch(error => console.error('Error loading navbar:', error));

      fetch('../../layout/footer.html')
        .then(response => response.text())
        .then(html => document.getElementById('footer-placeholder').innerHTML = html)
        .catch(error => console.error('Error loading footer:', error));

      // Initialize cart directly - let cart.js handle login check and redirection
      initializeCart();
    });

    // Initialize the cart and display items
    function initializeCart() {
      const cartContainer = document.getElementById('cart-items-container');
      const subtotalEl = document.getElementById('subtotal');
      const shippingCostEl = document.getElementById('shipping-cost');
      const totalCostEl = document.getElementById('total-cost');

      // Use the cart API to get cart items
      cart.getCart()
        .then(cartItems => {
          renderCart(cartItems);
        })
        .catch(error => {
          console.error('Error loading cart:', error);
          showToast('Error loading cart. Please try again.', 'error');
          renderCart([]);
        });

      // Render the cart items
      function renderCart(cartItems) {
        if (!cartItems || cartItems.length === 0) {
          cartContainer.innerHTML = `
            <div class="empty-cart-message">
              <h5>Your cart is empty</h5>
              <p class="text-muted">Add items to your cart to continue shopping.</p>
            </div>
          `;
          updateTotals(0);
          return;
        }

        // Build Cart Details
        let cartHTML = `
          <div class="select-all-container">
            <div class="form-check">
              <input class="form-check-input cart-item-checkbox" type="checkbox" id="select-all" checked>
              <label class="form-check-label" for="select-all">
                <strong>Select All Items</strong>
              </label>
            </div>
          </div>
        `;

        cartItems.forEach((item, index) => {
          const subtotal = (item.price * item.quantity).toFixed(2);
          cartHTML += `
            <div class="cart-item">
              <div class="row align-items-center">
                <div class="col-auto">
                  <input type="checkbox" class="cart-item-checkbox" data-index="${index}" data-id="${item.id}" data-price="${subtotal}" checked>
                </div>
                <div class="col-auto">
                  <img src="${item.image || 'https://via.placeholder.com/80'}" alt="${item.name}" class="product-image">
                </div>
                <div class="col">
                  <h5>${item.name}</h5>
                  <div class="text-muted small">${item.description || ''}</div>
                  <div class="mt-2 d-flex align-items-center">
                    <span class="price me-3">$${item.price.toFixed(2)}</span>
                    <div class="d-flex align-items-center">
                      <button class="btn btn-sm btn-outline-secondary btn-quantity decrease-qty" data-index="${index}" data-id="${item.id}">-</button>
                      <input type="number" min="1" value="${item.quantity}" class="quantity-input mx-2" data-index="${index}" readonly>
                      <button class="btn btn-sm btn-outline-secondary btn-quantity increase-qty" data-index="${index}" data-id="${item.id}">+</button>
                    </div>
                  </div>
                </div>
                <div class="col-auto text-end">
                  <div class="fw-bold mb-2">$${subtotal}</div>
                  <button class="btn btn-sm btn-danger remove-item" data-index="${index}" data-id="${item.id}">Remove</button>
                </div>
              </div>
            </div>
          `;
        });

        cartContainer.innerHTML = cartHTML;

        // Calculate and update price
        calculateTotals();

        // Add event listeners
        addEventListeners(cartItems);
      }

      // Add event listeners for cart interaction
      function addEventListeners(cartItems) {
        // Select all checkbox
        const selectAllCheckbox = document.getElementById('select-all');
        if (selectAllCheckbox) {
          selectAllCheckbox.addEventListener('change', function () {
            const isChecked = this.checked;
            document.querySelectorAll('.cart-item-checkbox:not(#select-all)').forEach(checkbox => {
              checkbox.checked = isChecked;
              const cartItem = checkbox.closest('.cart-item');
              if (isChecked) {
                cartItem.classList.remove('cart-item-unchecked');
              } else {
                cartItem.classList.add('cart-item-unchecked');
              }
            });
            calculateTotals();
          });
        }

        // Individual item checkboxes
        document.querySelectorAll('.cart-item-checkbox:not(#select-all)').forEach(checkbox => {
          checkbox.addEventListener('change', function () {
            const cartItem = this.closest('.cart-item');
            if (this.checked) {
              cartItem.classList.remove('cart-item-unchecked');
            } else {
              cartItem.classList.add('cart-item-unchecked');
            }

            // Update select all checkbox
            const allChecked = Array.from(document.querySelectorAll('.cart-item-checkbox:not(#select-all)')).every(cb => cb.checked);
            const selectAllCb = document.getElementById('select-all');
            if (selectAllCb) {
              selectAllCb.checked = allChecked;
            }

            calculateTotals();
          });
        });

        // Increase quantity
        document.querySelectorAll('.increase-qty').forEach(button => {
          button.addEventListener('click', function () {
            const productId = parseInt(this.dataset.id);
            const index = parseInt(this.dataset.index);
            if (index >= 0 && index < cartItems.length) {
              cart.updateCart(productId, cartItems[index].quantity + 1)
                .then(() => {
                  // Refresh cart after update
                  initializeCart();
                })
                .catch(error => {
                  console.error('Error updating cart:', error);
                  showToast('Error updating cart. Please try again.', 'error');
                });
            }
          });
        });

        // Decrease quantity
        document.querySelectorAll('.decrease-qty').forEach(button => {
          button.addEventListener('click', function () {
            const productId = parseInt(this.dataset.id);
            const index = parseInt(this.dataset.index);
            if (index >= 0 && index < cartItems.length && cartItems[index].quantity > 1) {
              cart.updateCart(productId, cartItems[index].quantity - 1)
                .then(() => {
                  // Refresh cart after update
                  initializeCart();
                })
                .catch(error => {
                  console.error('Error updating cart:', error);
                  showToast('Error updating cart. Please try again.', 'error');
                });
            }
          });
        });

        // Remove item
        document.querySelectorAll('.remove-item').forEach(button => {
          button.addEventListener('click', function () {
            const productId = parseInt(this.dataset.id);
            cart.removeFromCart(productId)
              .then(() => {
                showToast('Item removed from cart.', 'success');
                // Refresh cart after removal
                initializeCart();
              })
              .catch(error => {
                console.error('Error removing item from cart:', error);
                showToast('Error removing item. Please try again.', 'error');
              });
          });
        });

        // Checkout button
        document.getElementById('checkout-btn').addEventListener('click', function () {
          const selectedItems = [];
          document.querySelectorAll('.cart-item-checkbox:not(#select-all):checked').forEach(checkbox => {
            const index = parseInt(checkbox.dataset.index);
            if (index >= 0 && index < cartItems.length) {
              selectedItems.push(cartItems[index]);
            }
          });

          if (selectedItems.length === 0) {
            showToast('Please select at least one item to checkout.', 'warning');
            return;
          }

          // Store selected items for checkout page
          localStorage.setItem('checkoutItems', JSON.stringify(selectedItems));
          window.location.href = 'checkout.html';
        });
      }

      // Calculate totals based on selected items
      function calculateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.cart-item-checkbox:not(#select-all):checked').forEach(checkbox => {
          subtotal += parseFloat(checkbox.dataset.price);
        });

        updateTotals(subtotal);
      }

      // Update displayed totals
      function updateTotals(subtotal) {
        const shippingCost = 5.99;
        const total = subtotal + shippingCost;

        subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
        shippingCostEl.textContent = `$${shippingCost.toFixed(2)}`;
        totalCostEl.textContent = `$${total.toFixed(2)}`;

        const checkoutBtn = document.getElementById('checkout-btn');
        if (checkoutBtn) {
          checkoutBtn.disabled = subtotal === 0;
        }
      }
    }
  </script>
</body>

</html>